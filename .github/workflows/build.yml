# .github/workflows/build.yml

name: ROS Cross-Compile for NXP Edge

on:
  push:
    branches: [ "main" ]

jobs:
  build-ros-workspace:
    runs-on: self-hosted

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. NXP Yocto SDK 환경 설정 스크립트 실행
      - name: Setup Yocto SDK Environment
        run: |
          echo "Unsetting LD_LIBRARY_PATH to avoid conflicts..."
          unset LD_LIBRARY_PATH # <--- 바로 이 한 줄을 추가해주세요!
          
          echo "Sourcing the NXP Yocto SDK environment script..."
          source /opt/nxp-real-time-edge/2.5/environment-setup-armv8a-poky-linux
          # 환경이 잘 로드되었는지 컴파일러 버전 출력으로 확인
          echo "Compiler version: $($CC --version)"

      # 3. catkin_make를 사용하여 ROS 워크스페이스 빌드
      - name: Build ROS Catkin Workspace
        run: |
          echo "Building the workspace with catkin_make..."
          catkin_make -DCMAKE_TOOLCHAIN_FILE=src/toolchain.cmake

      # 4. 생성된 모든 실행 파일을 하나의 아티팩트로 압축하여 업로드
      - name: Upload Executable Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ros-nodes-binary
          path: devel/lib/
