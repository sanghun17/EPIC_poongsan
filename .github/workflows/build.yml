# .github/workflows/build.yml

name: ROS Cross-Compile for NXP Edge

on:
  push:
    branches: [ "main" ]

jobs:
  build-ros-workspace:
    runs-on: self-hosted

    steps:
      # 1. 코드를 catkin_ws/src 폴더 안에 내려받도록 경로 지정
      - name: Checkout Repository into catkin_ws/src
        uses: actions/checkout@v4
        with:
          path: catkin_ws/src

      # 2. ROS 및 Yocto SDK 환경 설정
      - name: Setup Build Environment
        run: |
          echo "Sourcing ROS and exporting variables to next steps"
          source /opt/ros/noetic/setup.bash
          # catkin_make가 필요한 핵심 환경 변수들을 GITHUB_ENV 파일에 기록하여 다음 단계로 전달합니다.
          echo "CMAKE_PREFIX_PATH=${CMAKE_PREFIX_PATH}" >> $GITHUB_ENV
          echo "ROS_PACKAGE_PATH=${ROS_PACKAGE_PATH}" >> $GITHUB_ENV

          echo "Unsetting LD_LIBRARY_PATH to avoid conflicts..."
          unset LD_LIBRARY_PATH
          
          echo "Sourcing the NXP Yocto SDK environment script..."
          source /opt/nxp-real-time-edge/2.5/environment-setup-armv8a-poky-linux
          
          echo "Compiler version: $($CC --version)"

      # 3. catkin_make를 올바른 경로와 올바른 toolchain 경로로 실행
      - name: Build ROS Catkin Workspace
        working-directory: catkin_ws
        run: |
          echo "Building the workspace from $(pwd)..."
          catkin_make -DCMAKE_TOOLCHAIN_FILE=$GITHUB_WORKSPACE/catkin_ws/src/toolchain.cmake

      # 4. 결과물 업로드
      - name: Upload Executable Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ros-nodes-binary
          path: catkin_ws/devel/lib/
